[gd_scene load_steps=7 format=2]

[ext_resource path="res://Scripts/Particle Systems/FishParticleSystem.cs" type="Script" id=1]
[ext_resource path="res://Textures/Fish.png" type="Texture" id=2]

[sub_resource type="Shader" id=1]
code = "shader_type canvas_item;

uniform vec4 baseColor : hint_color = vec4(.5, .5, .5, 1.0);
uniform vec4 startColor : hint_color = vec4(1.0, .25, .25, 1.0);
uniform float hueDifference = .65;
uniform float testId = 0f;

uniform float waveMagnitude = 1f;
uniform float waveFrequency = 1f;
uniform float waveSpeed = 1f;
uniform vec2 fishSize = vec2(9f);

varying float instanceId;

void vertex() {
	vec2 dir = sign((UV - .5f));
	VERTEX.y += dir.y * waveMagnitude * 2f;
	UV.y += dir.y * waveMagnitude * (1f / fishSize.y);
	
	instanceId = INSTANCE_CUSTOM.b;
	instanceId += testId;
}

vec3 rgb_to_hsv(vec3 rgb) {
	vec3 c = rgb;
	vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
	vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
	vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
	float d = q.x - min(q.w, q.y);
	float e = 1.0e-10;
	return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
}

vec3 hsv_to_rgb(vec3 hsv) {
	vec3 c = hsv;
	vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
	vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
	return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}

vec3 hsvShift(vec3 col, vec3 shift) {
	return hsv_to_rgb(fract(rgb_to_hsv(col) + shift));
}

void fragment() {
	vec2 uv = UV;
	uv.y += sin(uv.x * radians(360f) * waveFrequency + TIME * waveSpeed * radians(360f)) * waveMagnitude * (1f / fishSize.y);
	
	vec4 col = texture(TEXTURE, uv);
	
	vec3 t = step(.99, 1.0 - clamp(abs(col.rgb - baseColor.rgb), 0.0, 1.0));
	
	vec3 color = startColor.rgb;
	color = rgb_to_hsv(color);
	color.r += instanceId * hueDifference;
	color = hsv_to_rgb(color);
	
	col.rgb = mix(col.rgb, color.rgb, t);
	
	COLOR = col;
	COLOR.a *= step(0f, uv.y) * step(uv.y, 1f);
}


"

[sub_resource type="ShaderMaterial" id=2]
shader = SubResource( 1 )
shader_param/baseColor = Color( 0.5, 0.5, 0.5, 1 )
shader_param/startColor = Color( 1, 0.25, 0.25, 1 )
shader_param/hueDifference = 0.65
shader_param/testId = 0.0
shader_param/waveMagnitude = 0.5
shader_param/waveFrequency = 1.0
shader_param/waveSpeed = 2.0
shader_param/fishSize = Vector2( 2, 9 )

[sub_resource type="QuadMesh" id=3]

[sub_resource type="OpenSimplexNoise" id=4]
octaves = 1

[node name="Fishes" type="Node2D"]
material = SubResource( 2 )
script = ExtResource( 1 )
numParticles = 32
gravity = Vector2( 0, 0 )
mesh = SubResource( 3 )
texture = ExtResource( 2 )
fishSpeed = 32.0
fishSize = 9.0
steerSpeed = 1.0
numGroups = 1
scanRadius = 100.0
topForce = 128.0
terrainForce = 100.0
playerCollisionForce = 80.0
flowNoise = SubResource( 4 )
flowForce = 64.0

[node name="Sprite" type="Sprite" parent="."]
visible = false
use_parent_material = true
texture = ExtResource( 2 )
