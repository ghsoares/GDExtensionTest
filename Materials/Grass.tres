[gd_resource type="ShaderMaterial" load_steps=8 format=2]

[sub_resource type="Shader" id=1]
code = "shader_type canvas_item;

uniform sampler2D grassHeightMap;
uniform sampler2D grassAmountNoise;
uniform sampler2D gradient;
uniform float grassHeightMapSize = 64f;
uniform float grassAmountNoiseSize = 512f;
uniform float grassAmountHeightMapCurve = -2f;
uniform float grassAmountNoiseCurve = -2f;
uniform float grassAmount : hint_range(0f, 1f) = 1f;
uniform vec2 size = vec2(4096f, 16f);

uniform float windSpeed = 4f;
uniform float windFrequency = 1f;
uniform mat4 playerTransform;
uniform float playerDistortionDistance = 32f;
uniform float playerDistortionAmount = 16f;
uniform float playerThrusterPercentage = 1f;
uniform float playerThrusterLength = 32f;
uniform vec2 playerThrusterAngleRange = vec2(30f);
uniform float playerThrusterDistortionAmount = 64f;
uniform float playerThrusterDistortionSpeed = 2f;
uniform float playerThrusterDistortionFrequency = 2f;

varying vec2 v;
varying vec2 localV;
varying float time;

float Ease(float x, float c) {
	x = clamp(x, 0f, .999f);
	float curve1 = 1f - pow(1f - x, 1f / c);
	float curve2 = pow(x, c);
	float curve3 = pow(x * 2f, -c) * .5f;
	float curve4 = (1f - pow(1f - (x - .5f) * 2f, -c)) * .5f + .5f;
	float curveA = mix(curve1, curve2, step(1f, c));
	float curveB = mix(curve3, curve4, step(.5f, x));
	return mix(curveB, curveA, step(0f, c));
}

float cross2D(vec2 v1, vec2 v2) {
	return v1.x * v2.y - v1.y * v2.x;
}

float angle_between(vec2 v1, vec2 v2) {
	return atan(cross2D(v1, v2), dot(v1, v2));
}

void vertex() {
	v = UV;
	v.y = (v.y - .5f) * 2f;
	v *= size;
	
	localV = VERTEX;
	time = TIME;
}

vec2 CalculatePlayerDistortion(vec2 pos) {
	vec2 playerPos = playerTransform[3].xy;
	vec2 playerUp = -normalize(playerTransform[1].xy);
	vec2 playerDiff = (localV - playerPos);
	playerDiff.y = max(playerDiff.y, 0f);
	float playerDistance = length(playerDiff);
	float distT = 1f - clamp(playerDistance / playerDistortionDistance, 0f, 1f);
	distT = Ease(distT, -2f);
	
	vec2 dist = vec2(0f, 1f) * distT * playerDistortionAmount;
	
	float thrusterAngle = abs(angle_between(-playerUp, normalize(playerDiff)));
	//float thrusterT = 1f - clamp(thrusterAngle / radians(playerThrusterAngle), 0f, 1f);
	float thrusterT = (thrusterAngle - radians(playerThrusterAngleRange.x)) / (radians(playerThrusterAngleRange.y) - radians(playerThrusterAngleRange.x));
	thrusterT = 1f - clamp(thrusterT, 0f, 1f);
	vec2 thrusterDistortion = vec2(0f, 1f) * thrusterT * playerThrusterDistortionAmount * playerThrusterPercentage;
	float s = sin(abs(playerDiff.x) * playerThrusterDistortionFrequency * -radians(360f) + playerThrusterDistortionSpeed * radians(360f) * time);
	thrusterDistortion *= mix(.0f, 1f, s * .5f + .5f);
	thrusterDistortion *= 1f - clamp(playerDistance / playerThrusterLength, 0f, 1f);
	dist += thrusterDistortion;
	
	dist *= step(0f, pos.y);
	
	return dist;
}

void fragment() {
	float pi = radians(360f);
	vec2 pos = v;
	
	vec2 dist = CalculatePlayerDistortion(pos);
	pos += dist.xy;
	
	float wind = sin(pos.x * pi * (windFrequency * .01f) + windSpeed * time) * .5 + .5;
	pos.x += wind * (windSpeed * .02f) * pos.y;
	
	float h = texture(grassHeightMap, pos.xx / grassHeightMapSize).r;
	h = Ease(h, grassAmountHeightMapCurve);
	
	float nUv = pos.x / grassAmountNoiseSize;
	float amnt = texture(grassAmountNoise, vec2(nUv)).r;
	amnt = Ease(amnt, grassAmountNoiseCurve);
	amnt -= 1f;
	amnt += grassAmount * 2f;
	
	h *= clamp(amnt, 0, 1) * size.y;
	
	float t = pos.y / h;
	
	COLOR *= texture(gradient, vec2(t));
	COLOR.a *= step(t, 1f);
}"

[sub_resource type="Gradient" id=2]
offsets = PoolRealArray( 0, 0.366548, 0.818505 )
colors = PoolColorArray( 0.347656, 0.347656, 0.347656, 1, 0.738281, 0.738281, 0.738281, 1, 1, 1, 1, 1 )

[sub_resource type="GradientTexture" id=3]
gradient = SubResource( 2 )

[sub_resource type="OpenSimplexNoise" id=4]
octaves = 2

[sub_resource type="NoiseTexture" id=5]
seamless = true
noise = SubResource( 4 )

[sub_resource type="OpenSimplexNoise" id=6]
octaves = 1
period = 2.0

[sub_resource type="NoiseTexture" id=7]
noise = SubResource( 6 )

[resource]
resource_local_to_scene = true
shader = SubResource( 1 )
shader_param/grassHeightMapSize = 512.0
shader_param/grassAmountNoiseSize = 512.0
shader_param/grassAmountHeightMapCurve = -2.0
shader_param/grassAmountNoiseCurve = -2.0
shader_param/grassAmount = 0.423
shader_param/size = Vector2( 4096, 16 )
shader_param/windSpeed = 16.0
shader_param/windFrequency = 1.0
shader_param/playerTransform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 128, -62.598, 0 )
shader_param/playerDistortionDistance = 20.0
shader_param/playerDistortionAmount = 20.0
shader_param/playerThrusterPercentage = 0.0
shader_param/playerThrusterLength = 80.0
shader_param/playerThrusterAngleRange = Vector2( 15, 45 )
shader_param/playerThrusterDistortionAmount = 8.0
shader_param/playerThrusterDistortionSpeed = 4.0
shader_param/playerThrusterDistortionFrequency = 0.05
shader_param/grassHeightMap = SubResource( 7 )
shader_param/grassAmountNoise = SubResource( 5 )
shader_param/gradient = SubResource( 3 )
